/*! crmjsPlumb 2016-09-20 by Alex */
function AlexJsPlumb(a){this.init(a)}AlexJsPlumb.prototype={init:function(a){this.taskID=a.taskID,this.userID=a.userID,this.ajaxType=a.ajaxType,this.marketingPlanEditState=0,this.mouseDownState=!1,this.iconMouseDownState={state:!1,num:null,mouseup:!0},this.leftIconOffset=!1,this.mousedownClient=!1,this.jsPlumbBoxBorders={},this.iconTypeToClass=new Array,this.jsPlumbJson=new Array,this.jsPlumbJsonApi=a.jsPlumbJsonApi,this.addIconApi=a.addIconApi,this.delIconApi=a.delIconApi,this.editIconApi=a.editIconApi,this.marketingPlanTestApi=a.marketingPlanTestApi,this.implementPlanBackApi=a.implementPlanBackApi,this.formalSendApi=a.formalSendApi,this.stopSendApi=a.stopSendApi,this.testSendApi=a.testSendApi,this.jsPlumbBox=$("#jsPlumbBox"),this.connectArray=new Array,this.endpointSourceArray=new Array,this.targetSourceArray=new Array,this.instanceArray=new Array,this.iconSourceArray=new Array;var b={lineWidth:1,strokeStyle:"#7f7f7f",joinstyle:"round",outlineColor:"white",outlineWidth:2},c={lineWidth:1,strokeStyle:"#0190d4",outlineWidth:2,outlineColor:"white"},d={fillStyle:"#0190d4",strokeStyle:"#0190d4"};this.targetEndpoint={endpoint:"Dot",paintStyle:{fillStyle:"#0190d4",radius:6},hoverPaintStyle:d,maxConnections:-1,dropOptions:{hoverClass:"hover",activeClass:"active"},isTarget:!0,overlays:[["Label",{location:[.5,-.5],label:"Drop",cssClass:"endpointTargetLabel",visible:!1}]]},this.sourceEndpoint={endpoint:"Dot",paintStyle:{strokeStyle:"#0190d4",fillStyle:"transparent",radius:5,lineWidth:2},isSource:!0,connector:["Flowchart",{stub:[10,10],gap:8,cornerRadius:3,alwaysRespectStubs:!0}],connectorStyle:b,hoverPaintStyle:d,maxConnections:-1,connectorHoverStyle:c,dragOptions:{},overlays:[["Label",{location:[.5,1.5],label:"Drag",cssClass:"endpointSourceLabel",visible:!1}]]},this.iconTypeToClassFun(),this.readJsPlumbBoxBorders(),this.installLeftIcon(),this.addLeftIconEvent(),this.jsPlumbInit(),this.testButtonBind()},readJsPlumbBoxBorders:function(){var a=$(this.jsPlumbBox).offset();this.jsPlumbBoxBorders={top:a.top,right:a.left+$(this.jsPlumbBox).width(),bottom:a.top+$(this.jsPlumbBox).height(),left:a.left}},installLeftIcon:function(){for(var a=0;a<marketingPlanIconJson.length;a++){var b={};b.title=marketingPlanIconJson[a].title,b.iconList="";for(var c=0;c<marketingPlanIconJson[a].marketingFun.length;c++){var d={};d.title=marketingPlanIconJson[a].marketingFun[c].title,d.class="addJsPlumb "+marketingPlanIconJson[a].class+" "+marketingPlanIconJson[a].marketingFun[c].class,d.type=marketingPlanIconJson[a].marketingFun[c].type,d.parentClass=marketingPlanIconJson[a].class,marketingPlanIconJson[a].marketingFun[c].show&&(b.iconList+=this.substitute(this.marketingPlanIconTemplate_Li,d))}$("#marketingPlanIconBox").append(this.substitute(this.marketingPlanIconTemplate_Ul,b))}this.addLeftIconCopy()},addLeftIconCopy:function(){$("body").prepend('<div class="leftIconCopy" id="leftIconCopy"></div>'),$("body").prepend('<div class="nodeIconDelMenuBox" id="nodeIconDelMenuBox"><div class="nodeIconDelMenu" id="nodeIconDelMenu"><div class="delIcon">删除</div></div></div>'),$("#nodeIconDelMenu").bind("contextmenu",function(a){return!1}),this.delIconBind()},delIconBind:function(){var a=this;$("#nodeIconDelMenu .delIcon").click(function(){return"Start"==$(this).attr("data-type")?(a.bootstrapAlert("warning","警告！","不可以删除开始节点！"),!1):void $.ajax({type:a.ajaxType,url:a.delIconApi+"?timeStamp="+(new Date).getTime(),data:{taskID:a.taskID,userID:a.userID,icon_taskID:$(this).attr("data-taskid")},dataType:"json",timeout:2e4,beforeSend:function(){},success:function(b){if(b.result){for(var c=0;c<a.jsPlumbJson.length;c++)if(a.jsPlumbJson[c].ID==$(this).attr("data-id")){a.jsPlumbJson.splice(c,1);break}a.removeJsPlumbIcon($(this).attr("data-id"))}else a.bootstrapAlert("warning","警告！",b.error)}.bind(this),error:function(a,b,c){alert("ajax通信出错")}})})},addLeftIconEvent:function(){var a=this;$(".addJsPlumb").mousedown(function(b){b.preventDefault(),b.stopPropagation(),a.mouseDownState=!0;var c=a.leftIconOffset=$(this).offset(),d="top:"+c.top+"px; ",e="left:"+c.left+"px; ";a.mousedownClient={clientX:b.clientX,clientY:b.clientY};var f='<div id="iconMove" class="'+$(this).attr("class")+'" style="'+d+e+'" data-type="'+$(this).attr("data-type")+'" data-parent-class="'+$(this).attr("data-parent-class")+'">'+$(this).text();$("#leftIconCopy").html(f)}),$(window).mousemove(function(b){if(b.preventDefault(),b.stopPropagation(),a.mouseDownState){var c=b.clientY-(a.mousedownClient.clientY-a.leftIconOffset.top),d=b.clientX-(a.mousedownClient.clientX-a.leftIconOffset.left);$("#iconMove").css({left:d+"px",top:c+"px"})}}),$(window).mouseup(function(b){if(b.preventDefault(),b.stopPropagation(),1==b.which)if(a.mouseDownState){if(b.clientX>a.jsPlumbBoxBorders.left&&b.clientX<a.jsPlumbBoxBorders.right&&b.clientY>a.jsPlumbBoxBorders.top&&b.clientY<a.jsPlumbBoxBorders.bottom)if(0!==a.marketingPlanEditState)a.bootstrapAlert("warning","警告！","当前状态不可添加新节点！");else{for(var c={clientX:b.clientX-$(this.jsPlumbBox).offset().left-25,clientY:b.clientY-$(this.jsPlumbBox).offset().top-25,type:$("#iconMove").attr("data-type"),parentClass:$("#iconMove").attr("data-parent-class"),text:$("#iconMove").text()},d=!1,e=0;e<a.jsPlumbJson.length;e++)"Start"==a.jsPlumbJson[e].type&&(d=!0);if("Start"==$("#iconMove").attr("data-type")&&d&&a.jsPlumbJson.length>0)return a.mouseDownState=!1,a.leftIconOffset=!1,a.mousedownClient=!1,$("#leftIconCopy").html(""),a.bootstrapAlert("warning","警告！","每个计划只允许设置一个开始时间"),!1;a.addNewJsPlumbIcon(c)}}else if(a.iconMouseDownState.state){var f=$("#"+a.jsPlumbJson[a.iconMouseDownState.num].ID);if(a.iconMouseDownState.mouseup)if(0!==a.marketingPlanEditState)a.removeAllJsPlumb(),a.jsPlumbInstance();else if(b.clientX<a.jsPlumbBoxBorders.left||b.clientY<a.jsPlumbBoxBorders.top)a.removeAllJsPlumb(),a.jsPlumbInstance();else{var g=a.iconMouseDownState.num,h={taskID:a.taskID,userID:a.userID,icon_taskID:a.jsPlumbJson[g].taskID,icon_ID:a.jsPlumbJson[g].ID,icon_left:b.clientX-$(a.jsPlumbBox).offset().left-a.mousedownClient.mousedownX+$(a.jsPlumbBox).scrollLeft(),icon_top:b.clientY-$(a.jsPlumbBox).offset().top-a.mousedownClient.mousedownY+$(a.jsPlumbBox).scrollTop()};isNaN(h.icon_left)||(h.icon_left=10*Math.round(Math.round(h.icon_left)/10),h.icon_top=10*Math.round(Math.round(h.icon_top)/10),a.jsPlumbJson[g].left=h.icon_left,a.jsPlumbJson[g].top=h.icon_top,a.editIconAjax(h,g))}a.mousedownClient=!1,$(f).css({cursor:"pointer"}),a.iconMouseDownState.state=!1,a.iconMouseDownState.num=null,a.iconMouseDownState.mouseup=!0}a.mouseDownState=!1,a.leftIconOffset=!1,a.mousedownClient=!1,$("#leftIconCopy").html(""),$("#nodeIconDelMenu").hide()})},jsPlumbInit:function(){var a=this;$.ajax({type:a.ajaxType,url:this.jsPlumbJsonApi+"?timeStamp="+(new Date).getTime(),data:{taskID:this.taskID,userID:this.userID},dataType:"json",timeout:2e4,beforeSend:function(){},success:function(b){if(b.result){a.jsPlumbJson=b.list;for(var c=0;c<a.jsPlumbJson.length;c++)a.jsPlumbJson[c].left=a.jsPlumbJson[c].left<0?0:a.jsPlumbJson[c].left,a.jsPlumbJson[c].top=a.jsPlumbJson[c].top<0?0:a.jsPlumbJson[c].top;a.marketingPlanEditState=b.state,a.showTestButton(a.marketingPlanEditState),a.jsPlumbInstance()}else alert("初始化加载失败，点击确定重新加载数据！"),location.reload()},error:function(a,b,c){alert("ajax通信出错")}})},showTestButton:function(a){$(".marketingPlanRightBox .marketingBoxTopTitleBox > button").removeClass("menuOff"),$(".marketingPlanRightBox .marketingBoxTopTitleBox > button").attr({"data-menuoff":"off"}),0===a?($("#goTest").attr({"data-menuoff":"open"}),$("#goStart").addClass("menuOff"),$("#goRestart").addClass("menuOff"),$("#marketingPlanStateText").text("编辑状态")):1===a?($("#goTest").addClass("menuOff"),$("#goStart").addClass("menuOff"),$("#goRestart").attr({"data-menuoff":"open"}),$("#marketingPlanStateText").text("预执行中")):2===a?($("#goTest").addClass("menuOff"),$("#goStart").attr({"data-menuoff":"open"}),$("#goRestart").attr({"data-menuoff":"open"}),$("#marketingPlanStateText").text("预执行成功")):3===a?($("#goTest").addClass("menuOff"),$("#goStart").addClass("menuOff"),$("#goRestart").attr({"data-menuoff":"open"}),$("#marketingPlanStateText").text("正式发送中")):4===a&&($("#goTest").addClass("menuOff"),$("#goStart").addClass("menuOff"),$("#goRestart").addClass("menuOff"),$("#marketingPlanStateText").text("执行完成"))},testButtonBind:function(){var a=this;$("#goTest").click(function(){"open"==$(this).attr("data-menuoff")&&$.ajax({type:a.ajaxType,url:a.testSendApi+"?timeStamp="+(new Date).getTime(),data:{taskID:a.taskID,userID:a.userID},dataType:"json",timeout:2e4,beforeSend:function(){},success:function(b){b.result?(a.marketingPlanEditState=1,a.showTestButton(a.marketingPlanEditState),a.removeAllJsPlumb(),a.jsPlumbInstance()):a.bootstrapAlert("warning","警告！",b.error)},error:function(a,b,c){alert("ajax通信出错")}})}),$("#goStart").click(function(){"open"==$(this).attr("data-menuoff")&&$.ajax({type:a.ajaxType,url:a.formalSendApi+"?timeStamp="+(new Date).getTime(),data:{taskID:a.taskID,userID:a.userID},dataType:"json",timeout:2e4,beforeSend:function(){},success:function(b){b.result?(a.marketingPlanEditState=3,a.showTestButton(a.marketingPlanEditState),a.removeAllJsPlumb(),a.jsPlumbInstance()):a.bootstrapAlert("warning","警告！",b.error)},error:function(a,b,c){alert("ajax通信出错")}})}),$("#goRestart").click(function(){"open"==$(this).attr("data-menuoff")&&$.ajax({type:a.ajaxType,url:a.stopSendApi+"?timeStamp="+(new Date).getTime(),data:{taskID:a.taskID,userID:a.userID},dataType:"json",timeout:2e4,beforeSend:function(){},success:function(b){b.result?(a.marketingPlanEditState=0,a.showTestButton(a.marketingPlanEditState),a.removeAllJsPlumb(),a.jsPlumbInstance()):a.bootstrapAlert("warning","警告！",b.error)},error:function(a,b,c){alert("ajax通信出错")}})})},jsPlumbInstance:function(){this.instanceArray.length>0&&null==this.instanceArray[this.instanceArray.length-1],this.instanceArray.push(jsPlumb.getInstance({DragOptions:{cursor:"pointer",zIndex:200},ConnectionOverlays:[["Arrow",{width:8,length:8,location:1,visible:!0,id:"ARROW",events:{click:function(){alert("you clicked on the arrow overlay")}}}]],Container:"jsPlumbBox"}));var a=this.instanceArray[this.instanceArray.length-1];this.endpointSourceArray=[],this.targetSourceArray=[];for(var b=0;b<this.jsPlumbJson.length;b++)this.addNewChart(a,b),this.addJsPlumbIconBind($("#"+this.jsPlumbJson[b].ID)),1!==this.marketingPlanEditState&&2!==this.marketingPlanEditState||1===this.jsPlumbJson[b].state&&$("#"+this.jsPlumbJson[b].ID).addClass("runOk");0!==this.marketingPlanEditState&&$(this.jsPlumbBox).children(".jsPlumbIcon").children(".mask").addClass("openMask");var c=0;this.connectArray=[];for(var b=0;b<this.jsPlumbJson.length;b++)if(this.jsPlumbJson[b].targetId.length>0)for(var d=0;d<this.jsPlumbJson[b].targetId.length;d++)this.connectArray[c]=a.connect({uuids:[this.jsPlumbJson[b].ID+"RightMiddle",this.jsPlumbJson[b].targetId[d]+"LeftMiddle"],editable:!0}),c++;this.addJsPlumbBind(a),1===this.marketingPlanEditState?this.marketingPlanTest():3===this.marketingPlanEditState&&this.implementPlanBack()},addNewJsPlumbIcon:function(a){var b=this,c=this.jsPlumbJson.length;this.addNewChart(this.instanceArray[this.instanceArray.length-1],c,a),this.instanceArray[this.instanceArray.length-1].unbind(),this.addJsPlumbBind(this.instanceArray[this.instanceArray.length-1]),this.addJsPlumbIconBind($("#"+this.jsPlumbJson[c].ID)),$.ajax({type:b.ajaxType,url:this.addIconApi+"?timeStamp="+(new Date).getTime(),data:{taskID:this.taskID,userID:this.userID,icon_ID:this.jsPlumbJson[c].ID,icon_type:this.jsPlumbJson[c].type,icon_parentClass:this.jsPlumbJson[c].parentClass,icon_text:this.jsPlumbJson[c].text,icon_left:this.jsPlumbJson[c].left,icon_top:this.jsPlumbJson[c].top},dataType:"json",timeout:2e4,beforeSend:function(){},success:function(a){a.result?(b.jsPlumbJson[c].taskID=a.icon.taskID,$("#"+b.jsPlumbJson[c].ID).attr({"data-taskid":b.jsPlumbJson[c].taskID})):(b.jsPlumbJson.pop(),b.removeAllJsPlumb(),b.jsPlumbInstance(),b.bootstrapAlert("warning","警告！",a.error))},error:function(a,b,c){alert("ajax通信出错")}})},addJsPlumbIconBind:function(a){var b=this;$(a).dblclick(function(a){a.preventDefault(),a.stopPropagation(),$("#myModalBody").html(""),$("#myModal").modal("show"),$("#myModalLabel").html("节点编辑: "+$(this).children("h5").text()+' <span style="font-size:12px;color:#d9d9d9;">('+b.iconTypeToClass[$(this).attr("data-type")].title+")</span>");var c={};c.url=b.iconTypeToClass[$(this).attr("data-type")].popUrl+"?taskID="+b.taskID+"&icon_ID="+$(this).attr("id")+"&userID="+b.userID+"&icon_taskID="+$(this).attr("data-taskid")+"&timeStamp="+(new Date).getTime(),$("#myModalBody").html(b.substitute(b.iframeBox,c))}),$(a).mousedown(function(a){if(1==a.which){b.mousedownClient={mousedownX:a.clientX-$(this).offset().left,mousedownY:a.clientY-$(this).offset().top,left:$(this).css("left"),top:$(this).css("top")},$(b.jsPlumbBox).children(".jsPlumbIcon").css({"z-index":20}),$(this).css({"z-index":21});for(var c,d=0;d<b.jsPlumbJson.length;d++)if($(this).attr("id")==b.jsPlumbJson[d].ID){c=d;break}b.iconMouseDownState.state=!0,b.iconMouseDownState.num=c}}),$(a).mouseup(function(a){if(1==a.which){for(var c,d=0;d<b.jsPlumbJson.length;d++)if($(this).attr("id")==b.jsPlumbJson[d].ID){c=d;break}if(0!==b.marketingPlanEditState)$(this).css({left:b.jsPlumbJson[c].left+"px",top:b.jsPlumbJson[c].top+"px"}),b.iconMouseDownState.mouseup=!1;else{var e={taskID:b.taskID,userID:b.userID,icon_taskID:b.jsPlumbJson[c].taskID,icon_ID:b.jsPlumbJson[c].ID,icon_left:a.clientX-$(b.jsPlumbBox).offset().left-b.mousedownClient.mousedownX+$(b.jsPlumbBox).scrollLeft(),icon_top:a.clientY-$(b.jsPlumbBox).offset().top-b.mousedownClient.mousedownY+$(b.jsPlumbBox).scrollTop()};b.mousedownClient.left==$(this).css("left")&&b.mousedownClient.top==$(this).css("top")||isNaN(e.icon_left)||(e.icon_left=10*Math.round(Math.round(e.icon_left)/10),e.icon_top=10*Math.round(Math.round(e.icon_top)/10),$(this).css({left:e.icon_left+"px",top:e.icon_top+"px"}),b.jsPlumbJson[c].left=e.icon_left,b.jsPlumbJson[c].top=e.icon_top,b.editIconAjax(e,c)),b.mousedownClient=!1,$(this).css({cursor:"pointer"}),b.iconMouseDownState.state=!1,b.iconMouseDownState.num=null}}else 3==a.which&&(a.preventDefault(),a.stopPropagation(),$("#nodeIconDelMenu").show(),$("#nodeIconDelMenu").css({left:Math.round(a.clientX+$(window).scrollLeft())+"px",top:Math.round(a.clientY+$(window).scrollTop())+"px"}),$("#nodeIconDelMenu .delIcon").attr({"data-id":$(this).attr("id"),"data-taskid":$(this).attr("data-taskid"),"data-type":$(this).attr("data-type")}))}),$(a).mousemove(function(){b.iconMouseDownState.state&&$(this).css({cursor:"move"})}),$(a).bind("contextmenu",function(a){return!1})},addJsPlumbBind:function(a){var b=this;a.bind("dblclick",function(a,c){c.preventDefault(),c.stopPropagation(),0===b.marketingPlanEditState&&jsPlumb.detach(a)}),a.bind("connection",function(a,c){for(var d=$("#"+a.connection.sourceId).attr("data-type"),e=b.iconTypeToClass[$("#"+a.connection.targetId).attr("data-type")].sourceList,f=!1,g=0;g<e.length;g++)if(d==e[g]){f=!0;break}if(e!==!0&&f!==!0)return b.bootstrapAlert("warning","警告！","此节点不可以直接连接本节点！"),jsPlumb.detach(a.connection),!1;if(null==a.connection.suspendedElementId){var h;b.connectArray.push(a.connection);for(var g=0;g<b.jsPlumbJson.length;g++)if(b.jsPlumbJson[g].ID==a.connection.sourceId){b.jsPlumbJson[g].targetId.push(a.connection.targetId),h=g;break}var i={taskID:b.taskID,userID:b.userID,icon_taskID:b.jsPlumbJson[h].taskID,icon_ID:b.jsPlumbJson[h].ID,icon_targetId:b.jsPlumbJson[h].targetId};b.editIconAjax(i,h)}}),a.bind("connectionDetached",function(a){b.delConnection(a)}),a.bind("connectionMoved",function(a){if(a.connection.suspendedElementId==a.connection.targetId)return!1;for(var c=0;c<b.jsPlumbJson.length;c++)if(b.jsPlumbJson[c].ID==a.connection.sourceId){for(var d=0;d<b.jsPlumbJson[c].targetId.length;d++)if(b.jsPlumbJson[c].targetId[d]==a.connection.suspendedElementId){b.jsPlumbJson[c].targetId.splice(d,1),b.jsPlumbJson[c].targetId.push(a.connection.targetId);var e={taskID:b.taskID,userID:b.userID,icon_taskID:b.jsPlumbJson[c].taskID,icon_ID:b.jsPlumbJson[c].ID,icon_targetId:b.jsPlumbJson[c].targetId};b.editIconAjax(e,c);break}break}})},delConnection:function(a){for(var b=0;b<this.jsPlumbJson.length;b++)if(a.sourceId==this.jsPlumbJson[b].ID){for(var c=0;c<this.jsPlumbJson[b].targetId.length;c++)if(this.jsPlumbJson[b].targetId[c]==a.targetId){this.jsPlumbJson[b].targetId.splice(c,1);var d={taskID:this.taskID,userID:this.userID,icon_taskID:this.jsPlumbJson[b].taskID,icon_ID:this.jsPlumbJson[b].ID,icon_targetId:this.jsPlumbJson[b].targetId.length>0?this.jsPlumbJson[b].targetId:null};this.editIconAjax(d,b);break}break}},editIconAjax:function(a,b){var c=this;a.icon_ID="undefined"==typeof a.icon_ID?c.jsPlumbJson[b].ID:a.icon_ID,a.icon_state="undefined"==typeof a.icon_state?c.jsPlumbJson[b].state:a.icon_state,a.icon_left="undefined"==typeof a.icon_left?c.jsPlumbJson[b].left:a.icon_left,a.icon_top="undefined"==typeof a.icon_top?c.jsPlumbJson[b].top:a.icon_top,a.icon_text="undefined"==typeof a.icon_text?c.jsPlumbJson[b].text:a.icon_text,a.icon_targetId="undefined"==typeof a.icon_targetId?c.jsPlumbJson[b].targetId:a.icon_targetId,a.icon_taskID="undefined"==typeof a.icon_taskID?c.jsPlumbJson[b].taskID:a.icon_taskID,a.icon_type="undefined"==typeof a.icon_type?c.jsPlumbJson[b].type:a.icon_type,a.icon_parentClass="undefined"==typeof a.icon_parentClass?c.jsPlumbJson[b].parentClass:a.icon_parentClass,a.icon_userNum="undefined"==typeof a.icon_userNum?c.jsPlumbJson[b].userNum:a.icon_userNum,null!=a.icon_targetId&&(a.icon_targetId=JSON.stringify(a.icon_targetId)),$.ajax({type:c.ajaxType,url:c.editIconApi+"?timeStamp="+(new Date).getTime(),data:a,dataType:"json",timeout:2e4,beforeSend:function(){},success:function(a){a.result||(c.bootstrapAlert("warning","警告！",a.error),c.removeAllJsPlumb(),c.jsPlumbInit())},error:function(a,b,c){alert("ajax通信出错")}})},addNewChart:function(a,b,c){var d=this;if(b<this.jsPlumbJson.length)var e=this.jsPlumbJson[b];else{var e={ID:"jsPlumb_"+(new Date).getTime(),parentClass:c.parentClass,taskID:null,type:c.type,text:c.text,targetId:[],left:c.clientX+$(window).scrollLeft(),top:c.clientY+$(window).scrollTop()};e.left=10*Math.round(Math.round(e.left)/10),e.top=10*Math.round(Math.round(e.top)/10),this.jsPlumbJson.push(e)}var f=e.ID,g={};g.class="jsPlumbIcon "+this.iconTypeToClass[e.type].class+" jtk-node"+e.name+" new-"+e.name,g.id=f,g.dataType=e.type,g.parentClass=e.parentClass,g.dataTaskID=e.taskID,g.text=e.text,g.userNum=e.userNum,$(this.jsPlumbBox).append(this.substitute(this.iconTemplate,g)),$("#"+f).css("left",e.left+"px").css("top",e.top+"px").css("position","absolute").css("margin","0px"),g.userNum||$("#"+f+" .userNum").hide(),a.draggable(f),a.batch(function(){d._addEndpoints(a,f,"RightMiddle","LeftMiddle",b)})},_addEndpoints:function(a,b,c,d,e){var f=b+c;this.endpointSourceArray[e]=a.addEndpoint(b,this.sourceEndpoint,{anchor:c,uuid:f});var g=b+d;this.targetSourceArray[e]=a.addEndpoint(b,this.targetEndpoint,{anchor:d,uuid:g}),this.iconSourceArray[b]=e},removeAllJsPlumb:function(){if(this.instanceArray.length>0){this.instanceArray[this.instanceArray.length-1].unbind();for(var a=0;a<this.jsPlumbJson.length;a++)$("#"+this.jsPlumbJson[a].ID).unbind();this.instanceArray[this.instanceArray.length-1].deleteEveryEndpoint(),jsPlumb.empty(this.jsPlumbBox)}},removeJsPlumbIcon:function(a){$("#"+a).unbind(),this.instanceArray[this.instanceArray.length-1].deleteEndpoint(this.endpointSourceArray[this.iconSourceArray[a]]),this.instanceArray[this.instanceArray.length-1].deleteEndpoint(this.targetSourceArray[this.iconSourceArray[a]]),this.instanceArray[this.instanceArray.length-1].remove(a)},restartJsPlumbInit:function(){this.removeAllJsPlumb(),this.jsPlumbInit()},marketingPlanTest:function(){function a(){$.ajax({type:b.ajaxType,url:b.marketingPlanTestApi+"?timeStamp="+(new Date).getTime(),data:{taskID:b.taskID,userID:b.userID},dataType:"json",timeout:2e4,beforeSend:function(){},success:function(c){if(c.result){if("executing"==c.state||"end"==c.state){for(var d=0;d<c.list.length;d++)for(var e=0;e<b.jsPlumbJson.length;e++)if(c.list[d].ID==b.jsPlumbJson[e].ID){$("#"+b.jsPlumbJson[e].ID).addClass("runOk"),c.list[d].userNum&&($("#"+b.jsPlumbJson[e].ID+" .userNum").text(c.list[d].userNum),$("#"+b.jsPlumbJson[e].ID+" .userNum").show());break}if(void 0!=c.error&&""!=c.error)return void b.bootstrapAlert("warning","警告！",c.error);if("end"==c.state)return b.marketingPlanEditState=2,b.showTestButton(2),void b.bootstrapAlert("info","通知！","预执行成功!");setTimeout(function(){1===b.marketingPlanEditState&&a()},3e3)}}else b.bootstrapAlert("warning","警告！",c.error)},error:function(a,b,c){alert("ajax通信出错")}})}var b=this;a()},implementPlanBack:function(){function a(){$.ajax({type:b.ajaxType,url:b.implementPlanBackApi+"?timeStamp="+(new Date).getTime(),data:{taskID:b.taskID,userID:b.userID},dataType:"json",timeout:2e4,beforeSend:function(){},success:function(c){if(c.result)if("executing"==c.state){for(var d=0;d<c.list.length;d++)for(var e=0;e<b.jsPlumbJson.length;e++)if(c.list[d].ID==b.jsPlumbJson[e].ID){$("#"+b.jsPlumbJson[e].ID).addClass("runOk"),c.list[d].userNum&&($("#"+b.jsPlumbJson[e].ID+" .userNum").text(c.list[d].userNum),$("#"+b.jsPlumbJson[e].ID+" .userNum").show());break}void 0!=c.error&&""!=c.error?b.bootstrapAlert("warning","警告！",c.error):setTimeout(function(){3===b.marketingPlanEditState&&a()},3e3)}else"end"==c.state&&(b.marketingPlanEditState=4,b.showTestButton(4),b.bootstrapAlert("info","通知！","任务已完成!"));else b.bootstrapAlert("warning","警告！",c.error)},error:function(a,b,c){alert("ajax通信出错")}})}var b=this;a()},iconTypeToClassFun:function(){for(var a=0;a<marketingPlanIconJson.length;a++)for(var b=0;b<marketingPlanIconJson[a].marketingFun.length;b++)this.iconTypeToClass[marketingPlanIconJson[a].marketingFun[b].type]={class:marketingPlanIconJson[a].class+" "+marketingPlanIconJson[a].marketingFun[b].class,title:marketingPlanIconJson[a].marketingFun[b].title,popUrl:marketingPlanIconJson[a].marketingFun[b].popUrl,sourceList:marketingPlanIconJson[a].marketingFun[b].sourceList}},substitute:function(a,b){return a.replace(/\\?\{([^}]+)\}/g,function(a,c){return"\\"==a.charAt(0)?a.slice(1):void 0!=b[c]?b[c]:""})},bootstrapAlert:function(a,b,c){var d=$("#bootstrapAlertBox > .alert");if($(d).length>0)for(var e=0;e<$(d).length;e++)$(d[e]).animate({top:Number($(d[e]).css("top").replace(/px/,""))-70+"px"},"normal");var f="alert_"+(new Date).getTime(),g={};g.type=a,g.text=c,g.title=b,g.id=f,$("#bootstrapAlertBox").append(this.substitute(this.bootstrapAlertTemplate,g)),$("#"+f).css({left:($(window).width()-600)/2+"px",top:"300px"});setTimeout(function(){$("#"+f).alert("close")},5e3)},marketingPlanIconTemplate_Ul:['<ul class="iconBox">','<li class="groupTitle"><strong>{title}</strong>',"<ul>{iconList}</ul>","</li>","</ul>"].join(""),marketingPlanIconTemplate_Li:['<li class="{class}" data-type="{type}" data-parent-class="{parentClass}">{title}</li>'].join(""),iconTemplate:['<div class="{class}" id="{id}" data-type="{dataType}" data-taskID="{dataTaskID}" data-parent-class="{parentClass}">',"<h5>{text}</h5>",'<div class="userNum">{userNum}</div>','<div class="mask"></div>',"</div>"].join(""),iframeBox:'<iframe id="popIframeBox" name="popIframeBox" frameborder="0" marginheight="0" marginwidth="0" width="100%" style="min-height:200px;" src="{url}"></iframe>',bootstrapAlertTemplate:['<div class="alert alert-{type} alert-dismissible fade in" id="{id}">','<a href="#" class="close" data-dismiss="alert">&times;</a>','<div id="alertText"><strong>{title}</strong>{text}</div>',"</div>"].join("")};